<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WASM Test!</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.12.0/min/vs/loader.js"></script>
  <script src="wasm_webgl2.js"></script>
  <script>
    const monaco_vs_path = 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.12.0/min/vs';
    require.config({ paths: { 'vs': monaco_vs_path }});

    window.MonacoEnvironment = {
      getWorkerUrl: (workerId, label) => {
        return `data:text/javascript;charset=utf-8,${encodeURIComponent(`
          self.MonacoEnvironment = {
            baseUrl: '${monaco_vs_path}'
          };
          importScripts('${monaco_vs_path}/base/worker/workerMain.js');`
        )}`;
      }
    };

    const resizeCanvas = () => {
      const container = document.getElementById("canvas-container");
      const canvas = document.getElementById("canvas");
      canvas.width = container.clientWidth;
      canvas.height = container.clientHeight;
    };

    const resizeEditor = () => {
      if (window.editor) window.editor.layout();
    };

    const getShaderSource = () => {
      return Module.UTF8ToString(Module._getShaderSource());
    };
    const setShaderSource = (src) => {
      const src_ptr = Module.allocateUTF8(src);
      Module._setShaderSource(src_ptr);
      Module._free(src_ptr);
    };

    const init = () => {
      resizeCanvas();

      const id_ptr = Module.allocateUTF8("canvas");
      Module._init(id_ptr);
      Module._free(id_ptr);

      const onFrame = (timestamp) => {
        Module._update(timestamp / 1000.0);
        Module._render();
        window.requestAnimationFrame(onFrame);  
      };

      window.requestAnimationFrame(onFrame);

      require(["vs/editor/editor.main"], () => {
        const editor_elem = document.getElementById("editor-container");
        
        window.editor = monaco.editor.create(editor_elem, {
          value: getShaderSource(),
          theme: 'vs-dark',
          dragAndDrop: false,
          folding: false,
          scrollBeyondLastLine: false,
          minimap: { enabled: false }
        });

        window.editor.addAction({
          id: "shader-run",
          label: "Run Shader",
          keybindings: [ monaco.KeyMod.CtrlCmd | monaco.KeyCode.KEY_S ],
          contextMenuGroupId: "shader",
          contextMenuOrder: 0,
          run: (editor) => {
            setShaderSource(editor.getValue());
          }
        });

        window.editor.onDidChangeModelContent((event) => {
          // setShaderSource(window.editor.getValue());
        });

        resizeEditor();
      });
    };

    Module.onRuntimeInitialized = init;

    window.addEventListener('resize', () => {
      resizeCanvas();
      resizeEditor();
    });
  </script>
  <style>
    html, body {
      margin: 0;
      overflow: hidden;
    }
    body {
      background-color: #1e1e1e;
    }
    #canvas-container {
      position: absolute;
      top: 0;
      left: 40%;
      right: 0;
      bottom: 0;
    }
    #editor-container {
      position: absolute;
      top: 0;
      right: 60%;
      left: 0;
      bottom: 0;
    }
  </style>
</head>
<body>
  <div id="canvas-container">
    <canvas id="canvas" width="100" height="100"></canvas>
  </div>
  <div id="editor-container"></div>
</body>
</html>
